<template>
  <div class="page">
    <div class="navbar">
        <div style="text-align: center; margin-top: 4px;"><img src="img/key.png" width="60px" /></div>
        <div class="navbar-inner sliding">
            <div class="left">
                <a href="#" class="link back">
                    <i class="icon icon-back"></i>
                    <span class="if-not-md">Back</span>
                </a>
            </div>
        </div>
    </div>
    <div class="page-content">
      <div style="text-align: center; justify-content:center; margin-right:auto; margin-left:auto; width: 99%;">
        <script type="text/javascript">
          var IdUsuario = localStorage.getItem("IdUsuario");
          var Division = localStorage.getItem("Division");
          var IdCedula = app.views.main.router.currentRoute.params.IdCed;

          var $$ = Dom7;

          $$('.open-prompt').on('click', function () {
            app.dialog.prompt('Ingresa el correo electronico','Enviar PDF', function (name) {
              app.dialog.confirm('Seguro que esta correcto el correo?<br> ' + name, function () {
                app.dialog.alert('Ok, enviando a: ' + name );
                app.request.get('http://www.appbennetts.com/VIC/ProcesosVIC7/EnviarPDFVIC.php', { name: name, Division:Division, IdCedula: IdCedula, IdUsuario:IdUsuario}, function (data) {
                });
              });
            });
          });
        </script>
        <div>
          <img src="img/key.png" width="95px" height="40px" align="left">
          <img src="img/bennetts.png" width="180px" height="50px" align="right">
        </div>
        <p><br/><br/>
          <center><p><h2>Visita de impacto al cliente</h2></p></center>
        </p>
        <center><h3><font color="9FA1A3"><span id ="num"></span> - <span id ="cli"></span></font></h3></center><br>
        <div style="text-align: left; justify-content:left; margin-right:auto; margin-left:auto; width: 99%;">
          <div class="infinite-scroll-content">
            <table id = "imyal" cellpadding="10" >
              <header>
                <style>

                </style>
              </header>
              <tbody id="imya">
                <tr>
                  <th>Nombre comercial:</th>
                  <td><span id ="nomcom"></span></td>
                </tr>
                <tr>
                  <th>Contacto:</th>
                  <td><span id ="contac"></span></td>
                </tr>
                <tr>
                  <th>Teléfono:</th>
                  <td><span id ="tel"></span></td>
                </tr>
                <tr>
                  <th>Email:</th>
                  <td><span id ="email"></span></td>
                </tr>
                <tr>
                  <th>Estatus:</th>
                  <td><span id ="estat"></span></td>
                </tr>
                <tr>
                  <th>Localización:</th>
                  <td>Coordenadas<span id ="geolo"></span></td>
                </tr>
              </tbody>
            </table>
            <!-- <div class='sentencia1 preloader color-blue infinite-scroll-preloader'></div> -->
          </div><br><br>
          <hr>
          <button class="col button open-prompt"><img src="img/enviar.png" width="40px"> Enviar PDF</button>
          <hr>
        </div>
        <!----------------TABLA RESULTADOS-->
        <center><br>
                    <table>
                    <tr>
                        <td style='color: gray; font-size: 10px;'><span style="background-color: #88FF54;">&nbsp;&nbsp;&nbsp;</span> Aceptable&nbsp;&nbsp;</td>
                        <td style='color: gray; font-size: 10px;'><span style="background-color: #F6FE3D;">&nbsp;&nbsp;&nbsp;</span> Áreas por subsanar&nbsp;</td>
                        <td style='color: gray; font-size: 10px;'><span style="background-color: #FF4242;">&nbsp;&nbsp;&nbsp;</span> Sanción o clausura</td>
                    </tr>
                    <tr>
                        <td style='color: gray; font-weight: bold; text-align: center; font-size: 10px;'>De 47 a 54</td>
                        <td style='color: gray; font-weight: bold; text-align: center; font-size: 10px;'>De 42 a 46</td>
                        <td style='color: gray; font-weight: bold; text-align: center; font-size: 10px;'>Menos de 42</td>
                    </tr>
                </table>
                <table style="width: 100%; " bordercolor='#fff'>
                  <tr>
                      <th colspan='5' style='background-color: #3590FA; color: white; text-align: center;'>SEMAFORO DE RIESGO DE LA AUDITORIA</th>
                  </tr>
                  <tr> 
                      <th style='background-color: #929292; color: white; text-align: center;'>Rango</th>
                      <th style='background-color: #929292; color: white; text-align: center;'>Puntuacion total</th>
                      <th style='background-color: #929292; color: white; text-align: center;'>Porcentaje</th> 
                  </tr>
                  <tbody id="Resul">
                  </tbody>
                </table>
                <br>
                <br>
                <table id="TablaResultados" style="width: 100%;">
                  <!-- <tr>
                    <th id="NombreSegmento" colspan='4' style='background-color: #3590FA; color: white; text-align: center;'></th>
                    </tr>
                      <tr> 
                        <th style='background-color: #929292; color: white;text-align: center;'>#</th>
                        <th style='background-color: #929292; color: white;text-align: center;'>Pregunta</th>
                        <th style='background-color: #929292; color: white;text-align: center;'>Calificación</th>
                        <th style='background-color: #929292; color: white;text-align: center;'>Comentario</th> 
                      </tr>
                      <tr>
                          <td id="NumPregunta" style='text-align: center; size: 10px;'></td>
                          <td id="Pregunta" style='text-align: left; size: 10px;'></td>
                          <td id="Valor" style='text-align: center; size: 10px;'></td>
                          <td id="Comentario" style='text-align: left; size: 12px;'></td>
                      </tr>
                      <tbody>
                    </tbody> -->
                  </table>
                </center>

      </div>
    </div>
  </div>
</template>
<script>
  return {
    on: {
      pageInit: function (e, page) {
        var Division = app.views.main.router.currentRoute.params.Division;
        var cedula = app.views.main.router.currentRoute.params.IdCed;

        app.request.get('http://www.appbennetts.com/VIC/ProcesosVIC7/selectPorcentajeAuditoria.php', {IdCed: cedula}, function (data) {
             $('.sentencia1').remove();
            var content = JSON.parse(data);
             
              for(var i=0; i < content.length; i++){
                var numero    = content[i].Porcentaje;
                var Redondeado = numero.toFixed(2);  
                if(content[i].Total >= 47){
                  $("#Resul").append("<td style='background-color: #B8FE7A; font-weight: bold; text-align: center;'>Aceptable</td><td style='background-color: #B8FE7A; font-weight: bold; text-align: center;'>"+content[i].Total+"</td><td style='background-color: #B8FE7A; font-weight: bold; text-align: center;'>"+Redondeado+"%</td>");
                }
                if(content[i].Total >= 42 && content[i].Total <= 46){
                  $("#Resul").append("<td style='background-color: yellow; font-weight: bold; text-align: center;'>Áreas por subsanar</td><td style='background-color: yellow; font-weight: bold; text-align: center;'>"+content[i].Total+"</td><td style='background-color: yellow; font-weight: bold; text-align: center;'>"+Redondeado+"%</td>");
                }
                if(content[i].Total < 42 ){
                  $("#Resul").append("<td style='background-color: red; color:white; font-weight: bold; text-align: center;'>Sanción o clausura</td><td style='background-color: red; color:white; font-weight: bold; text-align: center;'>"+content[i].Total+"</td><td style='background-color: red; color:white; font-weight: bold; text-align: center;'>"+Redondeado+"%</td>");
                }
              }
            
          });

        
        app.request.get('http://www.appbennetts.com/VIC/ProcesosVIC7/selectAudi.php', {  IdCed: cedula, Division : Division}, function (data) {
            $('.sentencia1').remove();
            var content = JSON.parse(data);
            for(var c=0; c < content.length; c++){
              $("#num").html(content[c].IdCte);
              $("#cli").html(content[c].Cliente);
              $("#nom").html(content[c].IdCte);
              $("#contac").html(content[c].Contacto);
              $("#tel").html(content[c].Telefono);
              $("#nomcom").html(content[c].NomComercial);
              $("#email").html(content[c].Correo);
              $("#geolo").html("<br/>["+content[c].geolocation+"]");
              $("#imagya").html("<img src='"+content[c].Imagen+"'width='70' height='70' align='right'>");
              if(content[c].Estatus  == 1 && content[c].Facturacion == 1){
                $status = 'Activo';
              }
              if(content[c].Estatus == 1 && content[c].Facturacion == 0){
                $status = 'Bloqueado';
              }
              if(content[c].Estatus == 0 && content[c].Facturacion== 0){
                $status = 'Inactivo';
              }
              if(content[c].Estatus == 0 && content[c].Facturacion == 1){
                $status = 'Inativo';
              }
              $("#estat").html($status);
              $('.preloader').remove();
              $('.infinite-scroll-preloader').remove();
          }
        });
        //  
        app.request.get('http://www.appbennetts.com/VIC/ProcesosVIC7/selectSegmento.php', {}, function (data) {
            $('.sentencia1').remove();
            var content = JSON.parse(data);
            var con1 = 1;
            var y = 1;
             for (var i = 0; i < content.length; i++) {
              $("#TablaResultados").append("<tr><th id='NombreSegmento' colspan='4' style='background-color: #3590FA; color: white; text-align: center;'>"+content[i].NombreSegmento+"</th></tr><tr id='Preg1"+con1+"'></tr>");
                var IdSegmento = i+1;
               // alert(IdSegmento);
                preguntas(IdSegmento, con1);
                con1++;
             
           }
         });
        function preguntas(IdSegmento,con1){

          var cedula = app.views.main.router.currentRoute.params.IdCed;
          var IdCed = cedula;
          var Division = 0;
          var IdSegmento = IdSegmento;
          //alert(IdSegmento)
          var con = con1;

          app.request.get('http://www.appbennetts.com/VIC/ProcesosVIC7/selectAudiResul.php', {  IdCed: IdCed, Division : Division,IdSegmento:IdSegmento}, function (data2) {
                    //alert(data2);
                    //alert("hola "+con);
                    //$('.sentencia1').remove();
                    var content2 = JSON.parse(data2);
                    //alert(content2);
                    //alert("El Segmento "+IdSegmento +" Tiene "+content2.length+"Preguntas");
                    $("#Preg1"+IdSegmento).append("<tr><td style='background-color: #929292; color: white;text-align: center;'>#</td><td style='background-color: #929292; color: white;text-align: center;'>Pregunta</td><td style='background-color: #929292; color: white;text-align: center;'>Valor</td><td style='background-color: #929292; color: white;text-align: center;'>Comentario</td></tr>");
                     for (var x = 0; x < content2.length; x++) {
                      console.log(content2[x]);
                      $("#Preg1"+IdSegmento).append("<tr><td style='font-size: 10px; font-weight:bold;'>"+content2[x].NumPregunta+"</td><td style='font-size: 10px;'>"+content2[x].Pregunta+"</td><td style='font-size: 10px; text-align: center;'>"+content2[x].Valor+"</td><td style='font-size: 10px;'>"+content2[x].Comentario+"</td></tr>");
                     // $("#Preg2"+IdSegmento).append("<tr><td>"+content2[x].Pregunta+"</td></tr>");
                      
                      //con++;
                     }
                  });
        }


        //

        // app.request.get('http://www.appbennetts.com/VIC/ProcesosVIC7/selectAudiResul.php', {  IdCed: cedula, Division : Division}, function (data) {
        //     $('.sentencia1').remove();
        //     var content = JSON.parse(data);
        //     alert("Listo");
        //      for (var i = 0; i < content.length; i++) {
        //       alert(content[i].NombreSegmento);
              
        //     //   $("#TablaResultados").append("<tr><th id='NombreSegmento' colspan='4' style='background-color: #3590FA; color: white; text-align: center;'>"+content[i].NombreSegmento+"</th></tr><tr> <th style='background-color: #929292; color: white;text-align: center;'>#</th><th style='background-color: #929292; color: white;text-align: center;'>Pregunta</th><th style='background-color: #929292; color: white;text-align: center;'>Calificación</th><th style='background-color: #929292; color: white;text-align: center;'>Comentario</th> </tr><tr><td id='NumPregunta' style='text-align: center; size: 10px;'>"+content[i].NumPregunta+"</td><td id='Pregunta' style='text-align: left; size: 10px;'>"+content[i].Pregunta+"</td><td id='Valor' style='text-align: center; size: 10px;'>"+content[i].Valor+"</td><td id='Comentario' style='text-align: left; size: 12px;'>"+content[i].Comentario+"</td></tr><tbody></tbody>");
        //     }
        // });

      }
    }
  }
</script>
