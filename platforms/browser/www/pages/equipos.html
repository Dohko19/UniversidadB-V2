<template>
<div class="view view-main view-init safe-areas">
    <div class="page">
        <div class="navbar">
            <div style="text-align: center; margin-top: 4px;"><img src="img/key.png" width="60px" /></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" onclick="regresarRecorrido();">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">Back</span>
                    </a>
                </div>
                <div class="right" style="margin-right: 15px">
                    <a href="#" data-popup=".demo-popup-equipo" class="popup-open">
                        <i class="icon f7-icons if-not-md">help_round_fill</i>
                        <i class="icon material-icons if-md">help_outline</i>
                    </a>
                </div>
            </div>
        </div>

        <div class="popup demo-popup-equipo">
          <div class="page">
            <div class="navbar">
              <div class="navbar-inner">
                <div class="title" style="color: #a1a1a1">Ayuda</div>
                <div class="right"><a href="#" class="link popup-close">Close</a></div>
              </div>
            </div>
            <div class="page-content">
              <div class="block">

                <style type="text/css">
                  h2 {color: #222; text-align: center;}
                  .all {font-size: 10pt;color: #222; text-align: justify;}
                </style>
                <center>
                    <span style="color:#00008B; font-size: 20pt"><strong>Equipos</strong></span>
                </center>
                <hr width="90%">
                <span class="all">

                    <span style="text-align: justify;">En esta pantalla podremos elegir la opción del código que necesitamos a traves de un <font color="#1e90ff">selector</font>.</span><br />
                    <center><img src="img/ayuda/selectorEquipo.png" width="35%"></center><br /><br />
                    <span style="text-align: justify;"></span>Si se tiene que agregar un nuevo equipo al cliente con el que estamos trabajando y/o no se cuenta con el, desplegaremos una nueva pantalla con el boton de
                    <br> <center><img src="img/ayuda/signoMas.png" width="12%"></center>que nos ayudara a buscar el equipo y poder agregarlo.<br />
                    <center><img src="img/ayuda/agregarEquipo.png" width="70%"></center><br />
                    <center><span style="color:#a1a1a1;font-size: 9pt;text-align: justify;">El campo "Buscar producto" es un <strong>autocompletador</strong> y se encontraran coincidencias con lo que se escribe.<br/></span>
                        <font color="#a90000"><span><strong>NOTA:</strong></font> Recordar que al buscarlo y agregarlo, este se agrega directamente al selector dnde se debe buscar y seleccionarlo.</span><br /><br />
                    <span style="text-align: justify;">Ademas, una vez seleccionado el equipo se le tiene que agregar un estado del equipo</span><br />
                    <center><img src="img/ayuda/estado.png" width="70%"></center><br/>
                    <span style="text-align: justify;">que nos permite no solo reportar los daños, si no tambien identificar los que estan en buenas condiciones.</span><br />
                
              </div>
            </div>
          </div>
        </div>




        <div class="fab fab-center-bottom fab-morph" data-morph-to=".demo-fab-fullscreen-sheet.fab-morph-target">
                  <a href="#">
                    <i class="icon f7-icons if-not-md">add</i>
                    <i class="icon material-icons md-only">add</i>
                  </a>
                </div>
                <div class="demo-fab-fullscreen-sheet fab-morph-target">
                    <div style="text-align: right; width:90%;"><br /><a href="#" class="fab-close">Cerrar</a></div>
                    <h3 style="color:#00008B; text-align: center;">Agregar Equipo</h3>

                    <form data-search-container=".search-list" data-search-in=".item-title" class="searchbar searchbar-init">
                        <div class="searchbar-inner">
                            <div class="searchbar-input-wrap">
                                <input type="search" name="NuevoP" placeholder="Buscar Producto" id="autocomplete-dropdown-ajax"/>
                                <i class="searchbar-icon"></i>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </form>
                    <div style="width:95%; margin: 0 auto; border-collapse: collapse;">
                        <input type="hidden" id="PCode" name="PCode" />
                        <input type="hidden" style="font-weight: normal; width:95%;" id="PDesc" name="PDesc"/>
                        <table style="width:100%; margin: 0 auto; text-align: center;  border-collapse: collapse;">
                            <tr>
                                <td >
                                    <a href="#" onclick="guardadNuevoEq();" style="border: none; outline:none;"><img src="img/save2.png" width="40px" /></a>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                </div>
        <div class="page-content">
            <div style="text-align: center; justify-content:center; margin-right:auto; margin-left:auto; width: 99%;">
                <h2 style="color:#00008B;">Equipos</h2>
                <br />
                <img src="img/equipo.png" style="border: none; outline:none;" width="60px" />
                <form class="list" id="demo-form1">
                	
                    <div id="productos"> </div>
                    <span class="span" style="font-weight: bold;">Código:</span>
                    <select id="codigos" class ="spanBlanco" name="codigos" onchange="DatosEqu();">
                        <option value="0">Seleccione una opción</option>
                    </select>

                    <div style="float:left;">
                        <label class="item-radio item-content">
                            <input class="radioBM" type="radio" id="Bradio" name="demo-radio" value="Equipo en buen estado" />
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                              <div class="item-title">Buen estado</div>
                            </div>
                        </label>
                    </div>
                    <div style="float:right;">
                        <label class="item-radio item-content">
                            <input class="radioBM" type="radio" id="Mradio" name="demo-radio" value="Equipo en mal estado"/>
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                              <div class="item-title">Mal estado</div>
                            </div>
                        </label>
                    </div>
                    <br /><br />
                    <div>
                        <input type="hidden" id="DescEqu" name="DescEqu" /><br>

                        <span class="span" style="font-weight: bold;">Cantidad:</span>
                        <span id="text">
                            <input class ="spanBlanco" type='number' id="cantidad" name="cantidad" placeholder="Cantidad:" />
                        </span>

                        <span class="span" style="font-weight: bold;">Ubicación:</span>
                        <span id="text2">
                            <input type='text' id="ubicacion" name="ubicacion" placeholder='Ubicación:'  />
                        </span>
                        <span class="span" style="font-weight: bold;">Motivo (Ticke's):</span>             
                        <span id="text2">
                            <select id="tickets" name="tickets">
                                <option value="0">Seleccione una ópcion</option>
                                <option value="1">Daño del equipo por uso normal</option>
                                <option value="2">Equipo dañado por descuido</option>
                                <option value="3">Mantenimiento correctivo</option>
                            </select>
                        </span>
                        <span class="span" style="font-weight: bold;">Comentario:</span>
                        <span id="text">
                            <input class ="spanBlanco" type='text' id="comentario" name="comentario" placeholder="Comentario:" />
                        </span>
                    </div>
                </form>

                <a style="background-color: white; border: none; outline:none;" onclick="capturePhoto();"><img src="img/cam.png" width="50px" /></a>
	            <br />
	            <img style="display:none; margin: 0 auto;margin: 0 auto; width:90px; height:120px;" id="smallImage" src="" />
	            <input type="hidden" id="imagenC" name="imagenC"/>
                
                <!-- TABLA DE PRODUCTOS AGREGADOS --><br />
                <div class="block-title">Registros Guardados</div>
                <div class="card data-table" >
                <div class="infinite-scroll-content">

                    <table id="TabEquipos">
                        <thead>
                            <tr>
                                <th class="numeric-cell" style="text-align: center;">Acciones</th>
                                <th class="numeric-cell" style="text-align: center;">Fotografía</th>
                                <th class="numeric-cell" style="text-align: center;">Codigo</th>
                                <th class="numeric-cell" style="text-align: center;">Descripción</th>
                                <th class="numeric-cell" style="text-align: center;">Cantidad</th>
                                <th class="numeric-cell" style="text-align: center;">Ubicación</th>
                                <th class="numeric-cell" style="text-align: center;">Estatus</th>
                                <th class="numeric-cell" style="text-align: center;">Comentarios</th>
                                <th class="numeric-cell" style="text-align: center;">Motivo (Ticket)</th>
                            </tr>
                        </thead>
                    <div id="#mostrarP">
                        <tbody id="Eq">
                        
                        </tbody>
                    </div>
                    </table>
                    <div class='sentencia preloader color-red infinite-scroll-preloader'></div>
                </div>
                </div>
                <!-- FIN DE TABLA DE PRODUCTOS AGREGADOS -->
                <br />
                <div id="articles"></div>
                <table style="width:100%; margin: 0 auto; text-align: center;  border-collapse: collapse;">
                <tr>
                    <!--<td style="text-align: left;"><a href="#" class="link back" style="border: none; outline:none;"><img src="img/save2.png" width="40px" /></a></td> -->
                    <td style="text-align: right;"><a href="#" onclick="guardarEquipo();" style="border: none; outline:none;"><img src="img/save2.png" width="40px" /></a></td>
                </tr>
                </table>
                <br />
            </div>
        </div>
    </div>
</div>
</template>
<script>
  
  return {
    on: {
      pageInit: function (e, page) {
        var IdC = localStorage.getItem("IdCte");
        var Division = localStorage.getItem("Division");
        
        if(Division == 3){
            var NomEquipos = 'equipos_cteCDC';
            var NomBusEq = 'EquiposCDC';
            //select = document.getElementById("codigos");
        } else {
            var NomEquipos = 'equipos_cte';
            var NomBusEq = 'Equipos';
      
        
        
        } //aplica para la div soluciones
        app.request.get(cordova.file.externalRootDirectory + "/jsons/"+NomEquipos+".json", function (data) {
        var content = JSON.parse(data);
        select = document.getElementById("codigos");
        for(var i=0; i < content.length; i++){
            if(content[i].IdCte == IdC){
                option = document.createElement("option");
                option.value = content[i].IdPrd;
                option.text = unescape(content[i].IdPrd + "   " + content[i].Descripcion);
                select.appendChild(option);
            }
        }
        });
        $('#codigos').change(function () {
            var IdC = localStorage.getItem("IdCte");
            var cval = $("#codigos").val();
            app.request.get(cordova.file.externalRootDirectory + "/jsons/"+NomEquipos+".json", function (data) {                            
                var content2 = JSON.parse(data);
                for(var x = 0; x < content2.length; x++) {
                    if(content2[x].IdCte == IdC && content2[x].IdPrd == cval){
                        $("#ubicacion").val(content2[x].Ubicacion);
                        $("#DescEqu").val(content2[x].Descripcion);
                    }         
                } 
            });
        });
        $(".spanBlanco").change(function(){
            if ($(this).val()=="") {
                 $(this).css("background-color", "#ffffff");
            } else {
                 $(this).css("background-color", "#E0F8F7");
            }
        });
        //Cargar el contenido si lo tiene
         var icedula = localStorage.getItem("IdCedula");    
       databaseHandler.db.transaction(
            function(tx1){

                tx1.executeSql(
                    "Select * from ced_equipos where IdCedula= ?",
                    [icedula],
                    function(tx, results){
                        var length = results.rows.length;
                        for(var i = 0; i< length; i++){
                            var item = results.rows.item(i);
                            
	                            if(item.Tickets == 1){ 
	                                $NT = "Daño del equipo por uso normal";
	                            }else if(item.Tickets == 2){
	                                $NT = "Equipo dañado por descuido";
	                            }else if(item.Tickets == 3){
                                    $NT = "Mantenimiento correctivo";
                                }else if(item.Tickets != 1 || item.Tickets != 3 || item.Tickets != 3){
                                    $NT = "";
                                }

	                            $("#TabEquipos tbody").append("<tr id='fila"+ item.IdCedproductos +"'><td><a href='#' onclick='eliminarFila("+ item.IdCedproductos +",1);' style='border: none; outline:none;'><img src='img/borrar.png' width='30px' /></a><td><img src='"+item.ImgPrd+"' width='60px'/></td><td style='text-align: center;'>" + item.IdPrd + "</td><td style='text-align: center;'>" + unescape(item.Descripcion) + "</td><td style='text-align: center;'>"+ item.Cantidad + "</td><td style='text-align: center;'>" + item.Ubicacion + "</td><td>"+item.checkBox+"</td><td>"+  item.Comentario  +"</td><td>" +  $NT +"</td></tr>");
	                           
                        }

                        $('.preloader').remove();
                        $('.infinite-scroll-preloader').remove();
                    },
                    function(tx, error){
                        console.log("Error al consultar: " + error.message);
                    }
                );
                console.log("Consulta correcta");
            },
            function(error){},
            function(){}
        );
       //seccion del autocompletado
       self.autocompleteDropdownAjax = app.autocomplete.create({
            inputEl: '#autocomplete-dropdown-ajax',
            openIn: 'dropdown',
            preloader: true,
            valueProperty: 'IdPrd',
            textProperty:  'Descripcion',
            limit: 5, //limit to 20 results
            dropdownPlaceholderText: 'Seleccionar Producto...',
            source: function (query, render) {
                var autocomplete = this;
                var results = [];
                if (query.length === 0) {
                    render(results);
                    return;
                }
                autocomplete.preloaderShow();
                app.request({
                    url: cordova.file.externalRootDirectory + "/jsons/"+NomBusEq+".json",
                    method: 'GET',
                    dataType: 'json',
                    data: {
                    query: query,
                    },
                    success: function (data) {
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].Descripcion.toLowerCase().indexOf(query.toLowerCase()) >= 0) results.push(data[i].IdPrd+"-"+data[i].Descripcion); 
                        }
                        autocomplete.preloaderHide();
                        render(results);
                    }
                });
            }
        });

        $('#autocomplete-dropdown-ajax').change(function () {
            
            var cval = $("#autocomplete-dropdown-ajax").val();
            var cod = cval.split('-');
            var co = cod[0];

            app.request.get(cordova.file.externalRootDirectory + "/jsons/"+NomBusEq+".json", function (data) {                            
                var content2 = JSON.parse(data);
                for(var x = 0; x < content2.length; x++) {
                    if(content2[x].IdPrd == co){
                        
                        $("#PCode").val(content2[x].IdPrd);
                        $("#PDesc").val(content2[x].Descripcion);
                       $("#autocomplete-dropdown-ajax").val(content2[x].IdPrd + " - "+content2[x].Descripcion);

                    }         
                } 
            });

        });
        $('#Obser').change(function () {
            ObservacionesPe();
            
        });
       //fin de la seccion del autocompketador            
      }
    }  
  }
</script>